# 下一站 (Last Stop) - 公交拼图游戏

一个基于 Bevy 引擎开发的公交线路规划拼图游戏，玩家需要通过放置路线段来连接站点，帮助乘客到达目的地。

## 🎮 游戏概述

### 核心玩法

- **路线建设**：在网格地图上放置和旋转公交路线片段（直线、转弯、T型路口等）
- **乘客运输**：乘客从起点站出发，需要通过换乘到达目的地
- **连锁反应**：每条新路线会影响整个交通网络的客流分布
- **智能公交车**：使用先进的寻路算法自动驾驶的公交车系统

### 游戏特色

- 🚌 **智能公交车系统**：公交车会自动发现路线并运营
- 🔄 **动态换乘**：乘客可以在换乘点切换不同线路
- ⏱️ **实时模拟**：乘客有耐心值，需要及时提供交通服务
- 🎯 **多样化目标**：效率、成本、时间等多维度挑战
- 📊 **详细统计**：完整的乘客和运营数据追踪

## 🛠️ 技术实现

### 架构设计

- **Bevy ECS**：基于实体组件系统的模块化架构
- **智能寻路**：A* 算法驱动的路径规划系统
- **状态管理**：完整的游戏状态和场景管理
- **UI系统**：响应式用户界面和音效系统

### 核心系统

1. **路线系统** (`route_segment.rs`)
    - 支持6种路线段类型：直线、转弯、T型、十字、桥梁、隧道
    - 动态旋转和连接验证
    - 地形限制处理

2. **寻路系统** (`pathfinding.rs`)
    - A* 算法实现
    - 多模式路径计算（步行、公交、换乘）
    - 实时路径优化

3. **公交车系统** (`bus_pathfinding_system.rs`)
    - 智能路线发现
    - 自动驾驶和站点停靠
    - 动态载客管理

4. **乘客系统** (`passenger_boarding_system.rs`)
    - 智能上下车逻辑
    - 等车和乘车状态管理
    - 耐心值和满意度系统

## 🎯 关卡设计

### 渐进式难度

1. **教学关卡**：学习基本操作和连接概念
2. **换乘挑战**：掌握多路线协调和换乘机制
3. **网络优化**：在约束条件下寻找最优解
4. **时间压力**：测试快速反应和适应能力

### 评分系统

- **基础分数**：完成基本目标
- **效率奖励**：优化换乘次数和路径长度
- **速度奖励**：快速完成挑战
- **成本奖励**：节约建设成本

## 🕹️ 控制操作

### 基础操作

- **鼠标左键**：放置选中的路线段
- **鼠标右键**：旋转路线段
- **Delete/X键**：删除光标位置的路线段
- **WASD/方向键**：移动摄像机
- **鼠标滚轮**：缩放视图
- **Escape**：暂停/继续游戏

### 调试快捷键

- **F1**：显示详细调试信息
- **F2**：乘客生成统计
- **F3**：手动生成测试乘客
- **F4**：智能公交路线发现
- **F5**：智能公交车状态调试
- **F6**：乘客上下车系统调试
- **F7**：乘客移动状态详情
- **F8**：连接系统调试
- **F9**：分数计算调试
- **F12**：测试游戏失败界面

## 🚀 构建和运行

### 系统要求

- Rust 1.75+
- 支持 OpenGL/Vulkan 的显卡

### 构建步骤

```bash
# 克隆仓库
git clone <repository-url>
cd bus-puzzle-game

# 开发版本（包含调试功能）
cargo run --features dev

# 发布版本
cargo run --release
```

### Web版本构建

```bash
# 安装 trunk
cargo install trunk

# 构建 WASM 版本
trunk build --release
```

## 📁 项目结构

```
src/
├── main.rs                 # 主入口
├── bus_puzzle/             # 游戏核心模块
│   ├── mod.rs              # 模块导出
│   ├── components.rs       # 游戏组件定义
│   ├── config.rs           # 游戏配置常量
│   ├── level_system.rs     # 关卡系统
│   ├── pathfinding.rs      # 寻路算法
│   ├── bus_pathfinding_system.rs  # 公交车智能系统
│   ├── passenger_boarding_system.rs  # 乘客上下车系统
│   ├── connection_system.rs        # 连接验证系统
│   ├── interaction.rs      # 玩家交互
│   ├── ui_audio.rs         # UI和音效
│   ├── debug_info.rs       # 调试信息
│   └── ...                 # 其他系统模块
└── dev_tools.rs            # 开发工具（仅开发版）
```

## 🎨 资源文件

### 纹理资源

```
assets/textures/
├── routes/                 # 路线段纹理
│   ├── straight.png
│   ├── curve.png
│   ├── t_split.png
│   └── ...
├── stations/              # 站点纹理
│   ├── bus_stop.png
│   └── ...
├── passengers/            # 乘客图标
│   ├── red.png
│   └── ...
└── terrain/              # 地形纹理
    ├── grass.png
    └── ...
```

### 音频资源

```
assets/audio/
├── background_music.ogg
├── place_segment.ogg
├── passenger_arrive.ogg
└── ...
```

## 🔧 开发特性

### 调试系统

- 实时连接状态可视化
- 乘客行为追踪
- 性能指标监控
- 状态机调试

### 热重载

游戏支持资源热重载，方便开发调试。

### 扩展性

- 模块化的组件系统
- 可配置的关卡数据
- 插件化的功能扩展

## 🎮 游戏机制详解

### 连锁反应系统

- **客流连锁**：新路线开通后重新分配客流
- **换乘连锁**：多路线交汇创造新的出行可能
- **时间连锁**：发车间隔影响乘客等待体验

### 智能公交车

- 使用乘客验证过的寻路算法
- 自动发现最优运营路线
- 动态调头和往返运行
- 智能载客和站点停靠

### 乘客行为

- 真实的等车和乘车状态
- 基于耐心值的放弃机制
- 智能的上下车决策
- 多样化的出行需求

## 📈 性能优化

- ECS架构确保高效的系统更新
- 智能的路径缓存机制
- 优化的渲染管线
- 内存友好的资源管理

## 🤝 贡献指南

欢迎贡献代码！请确保：

1. 遵循现有的代码风格
2. 添加适当的文档注释
3. 包含必要的测试用例
4. 更新相关文档

## 📄 许可证

本项目采用双许可证授权：

### Apache License 2.0 或 MIT License

你可以选择以下任一许可证使用本项目：

- **Apache License 2.0** - 详见 [LICENSE-APACHE](LICENSE-APACHE) 文件
- **MIT License** - 详见 [LICENSE-MIT](LICENSE-MIT) 文件

除非你明确声明，否则根据 Apache-2.0 许可证的定义，你有意提交给本项目的任何贡献都将在上述双许可证下授权，不附加任何额外条款或条件。

## 🙏 致谢

- [Bevy Engine](https://bevyengine.org/) - 优秀的Rust游戏引擎
- 游戏设计灵感来自经典的交通规划游戏

---

享受构建你的公交帝国！🚌✨
